%
O114 (TEST M5540)
(06-06-2025 - A)
(THIS PROGRAM IS A TEST FOR M5540 MACRO)
(IT IS A MACRO FOR MILLING AN ISOSCELES TRIANGLE)
G10P0Z1538. (WORK OFFSET SETTING)

N100 M6T025300 (12MM SLOT MILL)
M43
G28H0
G50C0
G00X230.Y0
Z5.
G98G17 (Z-AXIS MILL)
G97
/M1 
M8
G262S5300M13
(SIDE MILL - 1D - 5000 RPM, 1500 MM/MIN FEED)
G66P5540 X116.U55.V37.5Z-12.D2.R5.S15Q10.H12A0B0C2F1700.
G00C30.
C60.
G67
M1
M15
G00Z50.
M999
M02


O5540 (MACRO MILL AN ISOSCELES TRIANGLE - ADAPTIVE)
(06-06-2025 - A)
(AXIS SHOULD BE G17)
(START Y IS 0, START X #24, HEIGHT U #21, WIDTH V #22)
(R #18 IS CLEARANGE HEIGHT)
(Q #17 IS PECK DEPTH IN -Z)
(Z #26 IS TOTAL DEPTH IN -Z)
(A #1 START IN CENTRE, BOOL)
(B #2 CUT DIRECTION 0 CLIMB, 1 CONVENTIONAL. REVERSE FOR REAR PROCESSING)
(C #3 1,2 OR 3 STRAIGHT, COVEX OR CONCAVE BASE)
(D #7 IS SURFACE)
(E #8 PLUNGE ANGLE IN DEG)
(F #9 FEED RATE)
(H #11 TOOL RADIUS)
(S #19 STEPOVER IN PERCENT)
N001 IF [#1EQ#0] THEN #1=0
N002 IF [#2EQ#0] THEN #2=0
N003 IF [#3EQ#0] THEN #3=1
N004 IF [#8EQ#0] THEN #8=2 (2 DEG PLUNGE)
N005 IF [#19EQ#0] THEN #19=20 (20 PERCENT)
N007 IF [[#18EQ0] OR [#18EQ#0] EQ1] GOTO 901
N008 IF [[#21EQ0] OR [#21EQ#0] EQ1] GOTO 902
N009 IF [[#22EQ0] OR [#22EQ#0] EQ1] GOTO 903
N010 IF [[#24EQ0] OR [#24EQ#0] EQ1] GOTO 904
N011 IF [[#26EQ0] OR [#26EQ#0] EQ1] GOTO 905
N012 IF [[#19LT1] OR [#19GT100] EQ1] GOTO 906

(PARAMS)
#100 = TLT[2] (TOOL IN TURRET 2)
#102 = [#[2300+[#100]]*2] (TOOL RADIUS)
#103 = [#3007AND4] (0, MIRROR IN Z = 1 )

(DEFAULTS)
IF [#11EQ#0] THEN #11 = #102
N013 IF [[#11EQ0] OR [#11EQ#0] EQ1] GOTO 907

#104 = [#22] (WIDTH)
#105 = ABS[#17] (PECK, REMOVE SIGN, WILL ALLWAYS BE NEGATIVE)
#106 = [#26 - #7] (CUT DEPTH LEFT)
IF [#2EQ1] THEN #104=[-#104] (SET CUTTING DIRECTION)
IF [#21LT0] THEN #104=[-#104] (MAINTAIN CUTTING DIRECTION IF INVERTED)
IF [ABS[#106]LT[#105]] THEN #105 = ABS[#106]

(FINNAL CUT SIZE)
#107 = [#24+[[#21*0.6666]*2]] (CENTROID X)
#108 = [#11*[#19/100]] (SIZE OF STEPOVER IN MM)

(INNER INITIAL CUT)
#110 = [#11/2] (CUTTER RADIUS, ITTERATION WIDTH)
#111 = [#110/#22] (SCALE FACTOR, WIDTH)
#112 = [#111*#21] (ITTERATION HEIGHT)
#113 = [SQRT[[#110*#110]+[#112*#112]]] (SIDE)
#114 = [#107-[[[#112]*0.6666]*2]] (APEX FROM CENTROID)
#115 = [[[#114]+[[#112]*2]]/2] (BASE RADIUS)

(CALCULATE PLUNGE Z FOR EACH SIDE)
#120 = [#113*[SIN[#8]]] (Z CUT SIDE)
#121 = [#110*[SIN[#8]]] (Z CUT BASE)
#122 = [[[#120]*2]+[#121]] (TOTAL Z CUT PER PERIMETER)

G00X[#114]Y0Z#18 (RAPID TO APEX SAFE Z)
G01Z#7F#9 (MOVE TO SURFACE)

(CUT TO DEPTH IN Z LOOP)
WHILE [#106 NE 0] DO1
    G01X[#114]Y0 (RESET TO INNER APEX)
    #125 = #105
    IF [[ABS[#106] - [#125]]LT0] THEN #125=ABS[#106]
    #106 = [#106 - [-[#125]]]
    #126 = [#120]
    #127 = [#121]

    (ITTERATE UNTIL DOWN TO PECK DEPTH)
    #128 = 0
    WHILE [[#128]NE1] DO2
        IF [[#125]EQ0] THEN #128 = 1

        IF [[[#125] - [#126]]LT0] THEN #126 = [#125]
        #125 = [#125] - [#126]
        G01U[[#112]*2]V[-[[#110]/2]]W[-[#126]]F#9 (SIDE 1)

                
        #110 = ABS[#110] (CORRECT BASE SIGN FOR CUT DIRECTION)
        IF [#104LE0] THEN #110 = -#110
        IF [[[#125] - [#127]]LT0] THEN #127 = [#125]
        #125 = [#125] - [#127]
        (START OF BASE OPTIONS)
        IF [#3 LE 1] GOTO 240
        IF [#3 EQ 2] GOTO 250
        IF [#3 EQ 3] GOTO 260
        N240 G01V[[#110]]W[-[#127]] (BASE)
        GOTO 280
        N250 G02V[[#110]]W[-[#127]]R[#115] (BASE)
        GOTO 280
        N260 G03V[[#110]]W[-[#127]]R[#115] (BASE)
        N280 (END OF BASE OPTIONS)

        IF [[[#125] - [#126]]LT0] THEN #126 = [#125]
        #125 = [#125] - [#126]
        G01X[#114]Y0W[-[#126]] (SIDE 2 BACK TO APEX)
    END2

    (NOW CUT OUTWARDS)
    #130 = #108 (STEP OVER)
    #131 = #112 (START HEIGHT)
    #132 = #21 (CUT HEIGHT LEFT)
    
    WHILE [[#132]NE0] DO3
        IF [[#130]GT[#132]] THEN #130 = [#132]
        #131 = [#131] + [#130]
        #132 = [[#21] - [#131]] (CUT HEIGHT LEFT)
        #133 = [#107] - [[[#131] * 0.6666] * 2]
        #134 = [[#131]/[#21]] (SCALE FACTOR, HEIGHT)
        #135 = [[#134]*[#22]] (CUT WIDTH)
        #115 = [[[#133]+[[#131]*2]]/2] (BASE RADIUS)
        #135 = ABS[#135]
        IF [#104 LT 0] THEN #135 = -#135

        G01X[[#133]]Y0F#9 (A)

        G01U[[#131]*2]V[-[#135]/2]

        (START OF BASE OPTIONS)
        IF [#3 LE 1] GOTO 550
        IF [#3 EQ 2] GOTO 560
        IF [#3 EQ 3] GOTO 570
        N550 G01V[#135] (C)
        GOTO 600
        N560 G02V[#135]R[#115] (C)
        GOTO 600
        N570 G03V[#135]R[#115] (C)
        N600(END OF BASE OPTIONS)

    END3
    G01X[[#133]]Y0F#9 (A)

END1

N800 G00Z#18 (RAPID TO CLEARANCE HEIGHT)

N900 GOTO 9999
N901 #3000=901(R MISSING OR 0 IN 5540 MACRO CALL)
N902 #3000=902(U MISSING OR 0 IN 5540 MACRO CALL)
N903 #3000=903(V MISSING OR 0 IN 5540 MACRO CALL)
N904 #3000=904(X MISSING OR 0 IN 5540 MACRO CALL)
N905 #3000=905(Z MISSING OR 0 IN 5540 MACRO CALL)
N906 #3000=906(S STEPOVER SHOULD BE BETWEEN 1 AND 100 IN 5540 MACRO CALL)
N907 #3000=907(H RADIUS OF TOOL MISSING)
N9999
M99
%